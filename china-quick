#!/usr/bin/env python3
"""
ğŸ‡¨ğŸ‡³ China Stock Quick Analyzer
Fast analysis tool for Chinese A-shares (simplified version)
"""

import sys
import argparse

def quick_analyze(ticker: str, name: str = ""):
    """Quick analysis using AKShare spot data"""
    try:
        import akshare as ak
        import pandas as pd
        
        ticker_clean = ticker.upper().replace('.SZ', '').replace('.SH', '')
        
        print(f"\n{'='*70}")
        print(f"ğŸ‡¨ğŸ‡³ ä¸­å›½Aè‚¡å¿«é€Ÿåˆ†æ: {name or ticker} ({ticker})")
        print(f"{'='*70}\n")
        
        # Get real-time data (fast)
        print("ğŸ“Š è·å–å®æ—¶æ•°æ®...")
        df = ak.stock_zh_a_spot_em()
        stock = df[df['ä»£ç '] == ticker_clean]
        
        if stock.empty:
            print(f"âŒ æœªæ‰¾åˆ°è‚¡ç¥¨ {ticker}")
            return
        
        row = stock.iloc[0]
        
        # Basic Info
        stock_name = row.get('åç§°', name or ticker)
        print(f"ğŸ“‹ åŸºæœ¬ä¿¡æ¯:")
        print(f"  è‚¡ç¥¨åç§°: {stock_name}")
        print(f"  è‚¡ç¥¨ä»£ç : {ticker_clean}")
        print(f"  æ‰€å±è¡Œä¸š: {row.get('æ‰€å±è¡Œä¸š', 'æœªçŸ¥')}")
        print("")
        
        # Price
        price = float(row['æœ€æ–°ä»·']) if pd.notna(row['æœ€æ–°ä»·']) else None
        change = float(row['æ¶¨è·Œå¹…']) if pd.notna(row['æ¶¨è·Œå¹…']) else None
        
        print("ğŸ’¹ è¡Œæƒ…æ•°æ®:")
        if price:
            print(f"  å½“å‰ä»·æ ¼: Â¥{price:.2f}")
        if change:
            emoji = "ğŸŸ¢" if change > 0 else "ğŸ”´"
            print(f"  {emoji} æ¶¨è·Œå¹…: {change:+.2f}%")
        print("")
        
        # Valuation
        print("ğŸ“ˆ ä¼°å€¼æŒ‡æ ‡:")
        pe = float(row['å¸‚ç›ˆç‡-åŠ¨æ€']) if pd.notna(row.get('å¸‚ç›ˆç‡-åŠ¨æ€')) else None
        pb = float(row['å¸‚å‡€ç‡']) if pd.notna(row.get('å¸‚å‡€ç‡')) else None
        mc = float(row['æ€»å¸‚å€¼']) / 100000000 if pd.notna(row.get('æ€»å¸‚å€¼')) else None
        
        if pe:
            pe_emoji = "ğŸŸ¢" if pe < 30 else "ğŸŸ¡" if pe < 50 else "ğŸ”´"
            print(f"  {pe_emoji} å¸‚ç›ˆç‡(TTM): {pe:.2f}")
        if pb:
            pb_emoji = "ğŸŸ¢" if pb < 3 else "ğŸŸ¡" if pb < 5 else "ğŸ”´"
            print(f"  {pb_emoji} å¸‚å‡€ç‡: {pb:.2f}")
        if mc:
            print(f"  æ€»å¸‚å€¼: {mc:.2f}äº¿")
        print("")
        
        # Technical
        print("ğŸ“‰ æŠ€æœ¯æŒ‡æ ‡:")
        high = float(row['æœ€é«˜']) if pd.notna(row.get('æœ€é«˜')) else None
        low = float(row['æœ€ä½']) if pd.notna(row.get('æœ€ä½')) else None
        open_price = float(row['ä»Šå¼€']) if pd.notna(row.get('ä»Šå¼€')) else None
        prev_close = float(row['æ˜¨æ”¶']) if pd.notna(row.get('æ˜¨æ”¶')) else None
        
        if high and low and price:
            position = (price - low) / (high - low) * 100 if high != low else 50
            pos_emoji = "ğŸŸ¢" if position > 60 else "ğŸŸ¡" if position > 40 else "ğŸ”´"
            print(f"  {pos_emoji} æ—¥å†…ä½ç½®: {position:.1f}% (é«˜{high:.2f}/ä½{low:.2f})")
        
        turnover = float(row['æ¢æ‰‹ç‡']) if pd.notna(row.get('æ¢æ‰‹ç‡')) else None
        if turnover:
            turn_emoji = "ğŸŸ¢" if turnover > 5 else "ğŸŸ¡" if turnover > 2 else "âšª"
            print(f"  {turn_emoji} æ¢æ‰‹ç‡: {turnover:.2f}%")
        
        amplitude = float(row['æŒ¯å¹…']) if pd.notna(row.get('æŒ¯å¹…')) else None
        if amplitude:
            print(f"  æŒ¯å¹…: {amplitude:.2f}%")
        print("")
        
        # Volume
        volume = float(row['æˆäº¤é‡']) / 10000 if pd.notna(row.get('æˆäº¤é‡')) else None
        turnover_amount = float(row['æˆäº¤é¢']) / 10000 if pd.notna(row.get('æˆäº¤é¢')) else None
        
        if volume:
            print("ğŸ’¹ æˆäº¤æƒ…å†µ:")
            print(f"  æˆäº¤é‡: {volume:.2f}ä¸‡æ‰‹")
        if turnover_amount:
            print(f"  æˆäº¤é¢: {turnover_amount:.2f}ä¸‡å…ƒ")
        print("")
        
        # Quick suggestion
        print("ğŸ’¡ å¿«é€Ÿè¯„ä¼°:")
        score = 0
        reasons = []
        
        if pe and pe < 30:
            score += 1
            reasons.append("ä¼°å€¼åˆç†")
        elif pe and pe > 50:
            score -= 1
            reasons.append("ä¼°å€¼åé«˜")
        
        if change and change > 5:
            score -= 1
            reasons.append("æ¶¨å¹…è¿‡å¤§ï¼Œè°¨æ…è¿½é«˜")
        elif change and change < -5:
            score += 1
            reasons.append("å›è°ƒè¾ƒå¤šï¼Œæˆ–æœ‰æœºä¼š")
        
        if turnover and turnover > 5:
            score += 1
            reasons.append("äº¤æŠ•æ´»è·ƒ")
        
        if score >= 2:
            suggestion = "ğŸŸ¢ å€¼å¾—å…³æ³¨"
        elif score >= 0:
            suggestion = "ğŸŸ¡ ä¸­æ€§è§‚æœ›"
        else:
            suggestion = "ğŸŸ  è°¨æ…å¯¹å¾…"
        
        print(f"  {suggestion}")
        if reasons:
            print(f"  ç†ç”±: {', '.join(reasons)}")
        
        print(f"\n{'='*70}\n")
        
        # Disclaimer
        print("âš ï¸ å…è´£å£°æ˜:")
        print("  ä»¥ä¸Šæ•°æ®æ¥è‡ªä¸œæ–¹è´¢å¯Œï¼Œä»…ä¾›å‚è€ƒ")
        print("  ä¸æ„æˆæŠ•èµ„å»ºè®®ï¼Œè¯·ç‹¬ç«‹åˆ¤æ–­")
        print("")
        
    except Exception as e:
        print(f"âŒ åˆ†æå‡ºé”™: {e}")
        import traceback
        traceback.print_exc()


def main():
    parser = argparse.ArgumentParser(description="ä¸­å›½Aè‚¡å¿«é€Ÿåˆ†æ")
    parser.add_argument("code", help="è‚¡ç¥¨ä»£ç  (å¦‚: 300017)")
    parser.add_argument("--name", "-n", help="è‚¡ç¥¨åç§° (å¯é€‰)", default="")
    
    args = parser.parse_args()
    
    quick_analyze(args.code, args.name)


if __name__ == "__main__":
    main()
