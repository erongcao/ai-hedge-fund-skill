#!/usr/bin/env python3
"""
ğŸ‡¨ğŸ‡³ China Stock Analyzer
Specialized analysis tool for Chinese A-shares
"""

import sys
import argparse
from typing import Dict, List

# Import our adapters
from china_data_adapter import ChinaDataAdapter, ChinaStockData
from china_news_adapter import ChinaNewsAdapter


def format_china_analysis(data: ChinaStockData, news_report: Dict) -> str:
    """Format analysis output for Chinese stocks"""
    lines = []
    
    lines.append(f"\n{'='*70}")
    lines.append(f"ğŸ‡¨ğŸ‡³ ä¸­å›½Aè‚¡åˆ†ææŠ¥å‘Š: {data.name} ({data.ticker})")
    lines.append(f"{'='*70}\n")
    
    # Basic Info
    lines.append("ğŸ“Š åŸºæœ¬ä¿¡æ¯:")
    lines.append(f"  è‚¡ç¥¨åç§°: {data.name}")
    lines.append(f"  è‚¡ç¥¨ä»£ç : {data.ticker}")
    lines.append(f"  æ‰€å±è¡Œä¸š: {data.industry or 'æœªçŸ¥'}")
    lines.append(f"  æ‰€å±æ¿å—: {data.sector or 'æœªçŸ¥'}")
    if data.listing_date:
        lines.append(f"  ä¸Šå¸‚æ—¥æœŸ: {data.listing_date}")
    lines.append("")
    
    # Price Info
    lines.append("ğŸ’¹ è¡Œæƒ…æ•°æ®:")
    if data.current_price:
        lines.append(f"  å½“å‰ä»·æ ¼: Â¥{data.current_price:.2f}")
    if data.change_pct:
        emoji = "ğŸŸ¢" if data.change_pct > 0 else "ğŸ”´"
        lines.append(f"  {emoji} æ¶¨è·Œå¹…: {data.change_pct:+.2f}%")
    if data.volume:
        lines.append(f"  æˆäº¤é‡: {data.volume:.2f}ä¸‡è‚¡")
    if data.turnover:
        lines.append(f"  æˆäº¤é¢: {data.turnover:.2f}ä¸‡å…ƒ")
    lines.append("")
    
    # Valuation
    lines.append("ğŸ“ˆ ä¼°å€¼æŒ‡æ ‡:")
    if data.pe_ratio:
        pe_emoji = "ğŸŸ¢" if data.pe_ratio < 30 else "ğŸŸ¡" if data.pe_ratio < 50 else "ğŸ”´"
        lines.append(f"  {pe_emoji} å¸‚ç›ˆç‡(TTM): {data.pe_ratio:.2f}")
    if data.pb_ratio:
        pb_emoji = "ğŸŸ¢" if data.pb_ratio < 3 else "ğŸŸ¡" if data.pb_ratio < 5 else "ğŸ”´"
        lines.append(f"  {pb_emoji} å¸‚å‡€ç‡: {data.pb_ratio:.2f}")
    if data.ps_ratio:
        lines.append(f"  å¸‚é”€ç‡: {data.ps_ratio:.2f}")
    if data.market_cap:
        lines.append(f"  æ€»å¸‚å€¼: {data.market_cap:.2f}äº¿")
    lines.append("")
    
    # Financials
    lines.append("ğŸ’° è´¢åŠ¡æŒ‡æ ‡:")
    if data.roe:
        roe_emoji = "ğŸŸ¢" if data.roe > 15 else "ğŸŸ¡" if data.roe > 10 else "ğŸ”´"
        lines.append(f"  {roe_emoji} å‡€èµ„äº§æ”¶ç›Šç‡(ROE): {data.roe:.2f}%")
    if data.gross_margin:
        gm_emoji = "ğŸŸ¢" if data.gross_margin > 30 else "ğŸŸ¡" if data.gross_margin > 15 else "ğŸ”´"
        lines.append(f"  {gm_emoji} æ¯›åˆ©ç‡: {data.gross_margin:.2f}%")
    if data.net_margin:
        lines.append(f"  å‡€åˆ©ç‡: {data.net_margin:.2f}%")
    if data.revenue:
        lines.append(f"  è¥ä¸šæ”¶å…¥: {data.revenue:.2f}äº¿")
    if data.net_profit:
        lines.append(f"  å‡€åˆ©æ¶¦: {data.net_profit:.2f}äº¿")
    if data.debt_ratio:
        debt_emoji = "ğŸŸ¢" if data.debt_ratio < 50 else "ğŸŸ¡" if data.debt_ratio < 70 else "ğŸ”´"
        lines.append(f"  {debt_emoji} èµ„äº§è´Ÿå€ºç‡: {data.debt_ratio:.2f}%")
    lines.append("")
    
    # Growth
    if data.revenue_growth or data.profit_growth:
        lines.append("ğŸ“Š æˆé•¿æ€§:")
        if data.revenue_growth:
            rg_emoji = "ğŸŸ¢" if data.revenue_growth > 20 else "ğŸŸ¡" if data.revenue_growth > 0 else "ğŸ”´"
            lines.append(f"  {rg_emoji} è¥æ”¶åŒæ¯”å¢é•¿: {data.revenue_growth:+.2f}%")
        if data.profit_growth:
            pg_emoji = "ğŸŸ¢" if data.profit_growth > 20 else "ğŸŸ¡" if data.profit_growth > 0 else "ğŸ”´"
            lines.append(f"  {pg_emoji} å‡€åˆ©æ¶¦åŒæ¯”å¢é•¿: {data.profit_growth:+.2f}%")
        lines.append("")
    
    # Technical
    if data.ma5 or data.rsi:
        lines.append("ğŸ“‰ æŠ€æœ¯æŒ‡æ ‡:")
        if data.ma5 and data.current_price:
            ma_emoji = "ğŸŸ¢" if data.current_price > data.ma5 else "ğŸ”´"
            lines.append(f"  {ma_emoji} MA5: Â¥{data.ma5:.2f}")
        if data.ma20:
            lines.append(f"  MA20: Â¥{data.ma20:.2f}")
        if data.ma60:
            lines.append(f"  MA60: Â¥{data.ma60:.2f}")
        if data.rsi:
            rsi_emoji = "ğŸŸ¢" if 30 < data.rsi < 70 else "ğŸ”´"
            lines.append(f"  {rsi_emoji} RSI(14): {data.rsi:.2f}")
        lines.append("")
    
    # News Analysis
    if news_report and news_report.get('analysis'):
        analysis = news_report['analysis']
        lines.append("ğŸ“° æ–°é—»èˆ†æƒ…åˆ†æ:")
        
        sentiment = analysis.get('sentiment', 'neutral')
        sent_emoji = {'positive': 'ğŸŸ¢', 'negative': 'ğŸ”´', 'neutral': 'ğŸŸ¡'}.get(sentiment, 'âšª')
        lines.append(f"  {sent_emoji} æ€»ä½“æƒ…æ„Ÿ: {sentiment.upper()}")
        lines.append(f"  æƒ…æ„Ÿå¾—åˆ†: {analysis.get('sentiment_score', 0):+.2f}")
        lines.append(f"  åˆ†ææ–°é—»æ•°: {analysis.get('total_news', 0)}ç¯‡")
        lines.append(f"    - æ­£é¢: {analysis.get('positive_count', 0)}ç¯‡")
        lines.append(f"    - è´Ÿé¢: {analysis.get('negative_count', 0)}ç¯‡")
        lines.append(f"    - ä¸­æ€§: {analysis.get('neutral_count', 0)}ç¯‡")
        
        key_topics = analysis.get('key_topics', [])
        if key_topics:
            lines.append(f"  å…³é”®è¯é¢˜: {', '.join(key_topics)}")
        
        lines.append(f"  æ€»ç»“: {analysis.get('summary', '')}")
        lines.append("")
        
        # Recent news
        news_items = news_report.get('news_items', [])
        if news_items:
            lines.append("ğŸ“° æœ€æ–°æ–°é—»:")
            for i, news in enumerate(news_items[:5], 1):
                sent_marker = {'positive': 'ğŸŸ¢', 'negative': 'ğŸ”´', 'neutral': 'ğŸŸ¡'}.get(news.sentiment, 'âšª')
                lines.append(f"  {i}. {sent_marker} {news.title[:50]}...")
                lines.append(f"     æ¥æº: {news.source} | {news.publish_time}")
            lines.append("")
    
    # Investment Suggestion
    lines.append("ğŸ’¡ æŠ•èµ„å»ºè®®:")
    suggestion = generate_china_investment_suggestion(data, news_report)
    lines.append(f"  {suggestion}")
    
    lines.append(f"\n{'='*70}\n")
    
    return "\n".join(lines)


def generate_china_investment_suggestion(data: ChinaStockData, news_report: Dict) -> str:
    """Generate investment suggestion based on analysis"""
    scores = []
    reasons = []
    
    # Valuation score
    if data.pe_ratio:
        if data.pe_ratio < 20:
            scores.append(2)
            reasons.append("ä¼°å€¼åä½")
        elif data.pe_ratio < 40:
            scores.append(1)
        else:
            scores.append(-1)
            reasons.append("ä¼°å€¼åé«˜")
    
    # Financial health score
    if data.roe:
        if data.roe > 15:
            scores.append(2)
            reasons.append("ROEä¼˜ç§€")
        elif data.roe > 10:
            scores.append(1)
        else:
            scores.append(-1)
    
    if data.debt_ratio:
        if data.debt_ratio < 50:
            scores.append(1)
            reasons.append("è´Ÿå€ºç‡ä½")
        elif data.debt_ratio > 70:
            scores.append(-1)
            reasons.append("è´Ÿå€ºç‡é«˜")
    
    # Growth score
    if data.profit_growth:
        if data.profit_growth > 30:
            scores.append(2)
            reasons.append("ç›ˆåˆ©é«˜å¢é•¿")
        elif data.profit_growth > 0:
            scores.append(1)
        else:
            scores.append(-1)
            reasons.append("ç›ˆåˆ©ä¸‹æ»‘")
    
    # News sentiment
    if news_report and news_report.get('analysis'):
        sentiment = news_report['analysis'].get('sentiment', 'neutral')
        if sentiment == 'positive':
            scores.append(1)
            reasons.append("èˆ†æƒ…æ­£é¢")
        elif sentiment == 'negative':
            scores.append(-1)
            reasons.append("èˆ†æƒ…è´Ÿé¢")
    
    total_score = sum(scores)
    
    if total_score >= 4:
        return f"ğŸŸ¢ å¼ºçƒˆçœ‹å¥½ - {', '.join(reasons[:3])}"
    elif total_score >= 2:
        return f"ğŸŸ¡ é€‚åº¦çœ‹å¥½ - {', '.join(reasons[:3])}"
    elif total_score >= 0:
        return f"âšª ä¸­æ€§è§‚æœ› - {', '.join(reasons[:3]) if reasons else 'ç­‰å¾…æ›´æ˜ç¡®ä¿¡å·'}"
    elif total_score >= -2:
        return f"ğŸŸ  è°¨æ…çœ‹ç©º - {', '.join(reasons[:3])}"
    else:
        return f"ğŸ”´ å»ºè®®å›é¿ - {', '.join(reasons[:3])}"


def main():
    parser = argparse.ArgumentParser(description="ä¸­å›½Aè‚¡åˆ†æå·¥å…·")
    parser.add_argument("code", help="è‚¡ç¥¨ä»£ç  (å¦‚: 300017, 600519)")
    parser.add_argument("--name", "-n", help="è‚¡ç¥¨åç§° (å¯é€‰ï¼Œç”¨äºæ–°é—»æœç´¢)")
    
    args = parser.parse_args()
    
    ticker = args.code
    name = args.name or ""
    
    print(f"\nğŸ” æ­£åœ¨åˆ†æ: {ticker} {name}...")
    print("è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ...\n")
    
    # Initialize adapters
    data_adapter = ChinaDataAdapter()
    news_adapter = ChinaNewsAdapter()
    
    # Fetch stock data
    print("ğŸ“Š è·å–è‚¡ç¥¨æ•°æ®...")
    stock_data = data_adapter.get_full_data(ticker)
    
    if not stock_data:
        print(f"âŒ æ— æ³•è·å– {ticker} çš„æ•°æ®ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®")
        return
    
    # Use actual name if not provided
    if not name and stock_data.name:
        name = stock_data.name
    
    # Fetch news
    print("ğŸ“° è·å–æ–°é—»èˆ†æƒ…...")
    news_report = news_adapter.get_stock_news_report(ticker, name)
    
    # Display analysis
    print(format_china_analysis(stock_data, news_report))


if __name__ == "__main__":
    main()
